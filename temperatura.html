<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperatura - FlashTemp</title>
    <link rel="icon" type="image/x-icon" href="https://i.ibb.co/Z1wrYWB0/logo-flashtemp-modified.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #124271;
            color: white;
            text-align: center;
            padding: 15px;
            background-image: url(https://cdn.pixabay.com/photo/2023/07/08/04/58/sunset-8113697_1280.jpg);
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            max-width: 1000px;
            margin: 0 auto 15px;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .temp-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffeb3b;
            margin: 15px 0;
        }
        .chart-container {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .chart-wrapper {
            height: 300px;
            position: relative;
        }
        .chart-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
        }
        .filtros {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        select, button, input[type="date"] {
            padding: 10px 15px;
            border-radius: 6px;
            border: 2px solid #bcddff;
            background: rgba(188, 221, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .tabla-container {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        .tabla-historico {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
        }
        .tabla-historico th {
            background: rgba(188, 221, 255, 0.2);
            padding: 12px;
            text-align: left;
            font-weight: bold;
            color: #ffeb3b;
            position: sticky;
            top: 0;
        }
        .tabla-historico td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .estado-calido { color: #ff6b6b; font-weight: bold; }
        .estado-normal { color: #4fc3f7; }
        .estado-frio { color: #64b5f6; font-weight: bold; }
        .loading { color: #bcddff; margin: 10px 0; }
        a { color: #bcddff; text-decoration: none; padding: 8px 16px; border: 2px solid #bcddff; border-radius: 6px; margin: 5px; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Datos de Temperatura</h1>
        <div class="temp-value" id="tempActual">-- ¬∞C</div>
        
        <div class="filtros">
            <select id="selectRango" onchange="cargarDatosGrafica()">
                <option value="1">√öltimas 24h</option>
                <option value="3">√öltimos 3 d√≠as</option>
                <option value="7">√öltima semana</option>
                <option value="30">√öltimo mes</option>
            </select>
        </div>

        <div class="chart-container">
            <h3>Gr√°fica de Temperatura</h3>
            <div class="loading" id="loadingChart">Cargando gr√°fica...</div>
            <div class="chart-wrapper">
                <canvas id="tempChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>Histograma de Temperaturas</h3>
            <div class="chart-wrapper">
                <canvas id="histogramChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>Tabla Hist√≥rica</h3>
            <div class="filtros">
                <input type="date" id="filtroFecha" onchange="filtrarTablaPorFecha()">
                <button onclick="mostrarTodasLasFechas()">Todas las Fechas</button>
            </div>
            <div class="tabla-container">
                <table class="tabla-historico">
                    <thead>
                        <tr><th>Fecha</th><th>Hora</th><th>Temp</th><th>Estado</th></tr>
                    </thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
        
        <a href="https://flashtemp.netlify.app">‚Üê Inicio</a>
        <a href="humedad.html">Humedad ‚Üí</a>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBm2mXJJpJZulKtTfLhoPX2-f2KhzdnSQw",
            authDomain: "flashtemp-87a59.firebaseapp.com",
            databaseURL: "https://flashtemp-87a59-default-rtdb.firebaseio.com",
            projectId: "flashtemp-87a59",
            storageBucket: "flashtemp-87a59.firebasestorage.app",
            messagingSenderId: "383528508510",
            appId: "1:383528508510:web:76a8cc4a8cb55c9c9928cf"
        };

        firebase.initializeApp(firebaseConfig);
        
        let tempChart, histogramChart;
        let todosLosDatos = [];

        async function cargarTodosLosDatos() {
            try {
                const snapshot = await firebase.database().ref('historico').once('value');
                const historico = snapshot.val();
                
                console.log("Datos de Firebase:", historico);
                
                todosLosDatos = [];
                if (historico) {
                    Object.keys(historico).forEach(fecha => {
                        Object.keys(historico[fecha]).forEach(hora => {
                            const dato = historico[fecha][hora];
                            // CORRECCI√ìN: Verificar que el dato tenga temperatura
                            if (dato && typeof dato.temperatura === 'number') {
                                todosLosDatos.push({
                                    fecha: fecha,
                                    hora: hora,
                                    temperatura: dato.temperatura,
                                    timestamp: new Date(fecha + 'T' + hora + ':00')
                                });
                            }
                        });
                    });
                    
                    todosLosDatos.sort((a, b) => b.timestamp - a.timestamp);
                    console.log("‚úÖ Datos procesados:", todosLosDatos.length);
                    console.log("üìÖ Ejemplo de datos:", todosLosDatos.slice(0, 3));
                    
                    // OCULTAR MENSAJE DE CARGA
                    const loadingElement = document.getElementById('loadingChart');
                    if (loadingElement) loadingElement.style.display = 'none';
                    
                    cargarDatosGrafica();
                    actualizarTabla();
                } else {
                    console.log("‚ùå No hay datos hist√≥ricos");
                    mostrarDatosDeEjemploTemporal();
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                mostrarDatosDeEjemploTemporal();
            }
        }

        function cargarDatosGrafica() {
            if (todosLosDatos.length === 0) {
                console.log("‚ùå No hay datos para gr√°ficas");
                mostrarDatosDeEjemploTemporal();
                return;
            }

            const dias = parseInt(document.getElementById('selectRango').value);
            const fechaLimite = new Date();
            fechaLimite.setDate(fechaLimite.getDate() - dias);
            fechaLimite.setHours(0, 0, 0, 0); // Resetear a inicio del d√≠a
            
            console.log("Fecha l√≠mite para filtrar:", fechaLimite);
            console.log("Total de datos disponibles:", todosLosDatos.length);

            // CORRECCI√ìN PRINCIPAL: Usar el timestamp ya convertido
            const datosFiltrados = todosLosDatos.filter(d => d.timestamp >= fechaLimite);
            
            console.log("üìà Datos filtrados para gr√°fica:", datosFiltrados.length);

            if (datosFiltrados.length === 0) {
                console.log("‚ö†Ô∏è No hay datos filtrados - mostrando todos los datos disponibles");
                // Si no hay datos en el rango, mostrar todos los disponibles
                crearGraficasConDatos(todosLosDatos);
                return;
            }

            crearGraficasConDatos(datosFiltrados);
        }

        // NUEVA FUNCI√ìN AUXILIAR MEJORADA
        function crearGraficasConDatos(datos) {
            console.log("üé® Creando gr√°ficas con", datos.length, "datos");
            
            if (datos.length === 0) {
                console.log("‚ùå No hay datos para crear gr√°ficas");
                mostrarDatosDeEjemploTemporal();
                return;
            }

            const dias = parseInt(document.getElementById('selectRango').value);
            let labels = [];
            let promedios = [];

            if (dias === 1) {
                // Agrupar por hora para √∫ltimas 24h
                const datosPorHora = {};
                datos.forEach(dato => {
                    const hora = dato.hora.substring(0, 5); // Tomar solo HH:MM
                    if (!datosPorHora[hora]) datosPorHora[hora] = [];
                    datosPorHora[hora].push(dato.temperatura);
                });

                labels = Object.keys(datosPorHora).sort();
                promedios = labels.map(hora => {
                    const temps = datosPorHora[hora];
                    return temps.reduce((a, b) => a + b, 0) / temps.length;
                });

            } else {
                // Agrupar por fecha para m√∫ltiples d√≠as
                const datosPorDia = {};
                datos.forEach(dato => {
                    if (!datosPorDia[dato.fecha]) datosPorDia[dato.fecha] = [];
                    datosPorDia[dato.fecha].push(dato.temperatura);
                });

                labels = Object.keys(datosPorDia).sort();
                promedios = labels.map(fecha => {
                    const temps = datosPorDia[fecha];
                    return temps.reduce((a, b) => a + b, 0) / temps.length;
                });

                // Formatear fechas para mostrar
                labels = labels.map(fecha => {
                    const [a√±o, mes, dia] = fecha.split('-');
                    return `${dia}/${mes}`;
                });
            }

            console.log("üè∑Ô∏è Labels:", labels);
            console.log("üìä Promedios:", promedios);
            
            crearGraficaPrincipal(labels, promedios);
            crearHistograma(datos.map(d => d.temperatura));
        }

        function crearGraficaPrincipal(labels, datos) {
            const canvas = document.getElementById('tempChart');
            if (!canvas) {
                console.log("‚ùå Canvas no encontrado");
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Destruir gr√°fica anterior
            if (tempChart) {
                tempChart.destroy();
            }
            
            console.log("üîÑ Creando gr√°fica principal...");
            
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperatura (¬∞C)',
                        data: datos,
                        borderColor: '#ffeb3b',
                        backgroundColor: 'rgba(255, 235, 59, 0.3)',
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#ffeb3b',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000
                    },
                    plugins: {
                        legend: { 
                            display: true, 
                            labels: { 
                                color: 'white', 
                                font: { size: 14, weight: 'bold' } 
                            } 
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: 'white', font: { size: 12 } },
                            grid: { color: 'rgba(255,255,255,0.2)' }
                        },
                        y: { 
                            ticks: { color: 'white', font: { size: 12 } },
                            grid: { color: 'rgba(255,255,255,0.2)' },
                            min: Math.min(...datos) - 2,
                            max: Math.max(...datos) + 2
                        }
                    }
                }
            });
            
            console.log("‚úÖ Gr√°fica principal creada");
        }

        function crearHistograma(temperaturas) {
            const canvas = document.getElementById('histogramChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (histogramChart) histogramChart.destroy();

            // Ajustar bins din√°micamente seg√∫n los datos
            const minTemp = Math.min(...temperaturas);
            const maxTemp = Math.max(...temperaturas);
            const binSize = 2;
            
            const bins = [];
            for (let i = Math.floor(minTemp); i <= Math.ceil(maxTemp); i += binSize) {
                const count = temperaturas.filter(temp => temp >= i && temp < i + binSize).length;
                bins.push({ range: `${i}-${i+binSize}¬∞C`, count: count });
            }

            histogramChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.map(b => b.range),
                    datasets: [{
                        label: 'Frecuencia',
                        data: bins.map(b => b.count),
                        backgroundColor: 'rgba(255, 235, 59, 0.8)',
                        borderColor: '#ffeb3b',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000
                    },
                    plugins: {
                        legend: { 
                            display: true, 
                            labels: { color: 'white', font: { size: 14 } } 
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: 'white', font: { size: 11 } },
                            grid: { color: 'rgba(255,255,255,0.2)' }
                        },
                        y: { 
                            ticks: { color: 'white', font: { size: 12 } },
                            grid: { color: 'rgba(255,255,255,0.2)' },
                            beginAtZero: true
                        }
                    }
                }
            });
            
            console.log("‚úÖ Histograma creado");
        }

        function mostrarDatosDeEjemploTemporal() {
            console.log("üîÑ Mostrando datos de ejemplo temporal...");
            const loadingElement = document.getElementById('loadingChart');
            if (loadingElement) loadingElement.style.display = 'none';
            
            const labels = ['14:00', '15:00', '16:00', '17:00', '18:00'];
            const datos = [25.3, 25.8, 26.2, 25.9, 25.5];
            
            crearGraficaPrincipal(labels, datos);
            crearHistograma(datos);
        }

        function actualizarTabla() {
            const cuerpoTabla = document.getElementById('cuerpoTabla');
            if (!cuerpoTabla) return;
            
            if (todosLosDatos.length === 0) {
                cuerpoTabla.innerHTML = '<tr><td colspan="4" style="text-align: center;">No hay datos</td></tr>';
                return;
            }
            
            const datosMostrar = todosLosDatos.slice(0, 20);
            
            cuerpoTabla.innerHTML = datosMostrar.map(dato => {
                const estado = dato.temperatura >= 28 ? 'Caluroso' : dato.temperatura <= 20 ? 'Fr√≠o' : 'Normal';
                const claseEstado = dato.temperatura >= 28 ? 'estado-calido' : dato.temperatura <= 20 ? 'estado-frio' : 'estado-normal';
                return `<tr>
                    <td>${dato.fecha}</td>
                    <td>${dato.hora}</td>
                    <td>${dato.temperatura.toFixed(1)}¬∞C</td>
                    <td class="${claseEstado}">${estado}</td>
                </tr>`;
            }).join('');
        }

        function filtrarTablaPorFecha() {
            const fecha = document.getElementById('filtroFecha').value;
            if (!fecha) {
                actualizarTabla();
                return;
            }
            
            const datosFiltrados = todosLosDatos.filter(d => d.fecha === fecha);
            const cuerpoTabla = document.getElementById('cuerpoTabla');
            
            if (datosFiltrados.length === 0) {
                cuerpoTabla.innerHTML = '<tr><td colspan="4" style="text-align: center;">No hay datos para esta fecha</td></tr>';
                return;
            }
            
            cuerpoTabla.innerHTML = datosFiltrados.map(dato => {
                const estado = dato.temperatura >= 28 ? 'Caluroso' : dato.temperatura <= 20 ? 'Fr√≠o' : 'Normal';
                const claseEstado = dato.temperatura >= 28 ? 'estado-calido' : dato.temperatura <= 20 ? 'estado-frio' : 'estado-normal';
                return `<tr>
                    <td>${dato.fecha}</td>
                    <td>${dato.hora}</td>
                    <td>${dato.temperatura.toFixed(1)}¬∞C</td>
                    <td class="${claseEstado}">${estado}</td>
                </tr>`;
            }).join('');
        }

        function mostrarTodasLasFechas() {
            document.getElementById('filtroFecha').value = '';
            actualizarTabla();
        }

        firebase.database().ref('temperatura').on('value', (snapshot) => {
            const temp = snapshot.val();
            if (temp !== null) {
                document.getElementById('tempActual').innerText = temp.toFixed(1) + " ¬∞C";
            }
        });

        // INICIALIZAR
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üöÄ Iniciando aplicaci√≥n...");
            cargarTodosLosDatos();
        });

        // BACKUP POR SI FALLA LA CARGA
        setTimeout(function() {
            const loadingElement = document.getElementById('loadingChart');
            if (loadingElement && loadingElement.style.display !== 'none') {
                console.log("Forzando visualizaci√≥n...");
                mostrarDatosDeEjemploTemporal();
            }
        }, 5000);
    </script>
</body>
</html>
