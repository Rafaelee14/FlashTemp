<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temperatura - FlashTemp</title>
    <link rel="icon" type="image/x-icon" href="https://i.ibb.co/Z1wrYWB0/logo-flashtemp-modified.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #124271;
            color: white;
            text-align: center;
            padding: 15px;
            background-image: url(https://cdn.pixabay.com/photo/2023/07/08/04/58/sunset-8113697_1280.jpg);
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            max-width: 1000px;
            margin: 0 auto 15px;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .temp-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffeb3b;
            margin: 15px 0;
        }
        .chart-container {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .chart-wrapper {
            height: 300px;
            position: relative;
        }
        .filtros {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        select, button, input[type="date"] {
            padding: 10px 15px;
            border-radius: 6px;
            border: 2px solid #bcddff;
            background: rgba(188, 221, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .tabla-container {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        .tabla-historico {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
        }
        .tabla-historico th {
            background: rgba(188, 221, 255, 0.2);
            padding: 12px;
            text-align: left;
            font-weight: bold;
            color: #ffeb3b;
            position: sticky;
            top: 0;
        }
        .tabla-historico td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .loading { color: #bcddff; margin: 10px 0; }
        a { color: #bcddff; text-decoration: none; padding: 8px 16px; border: 2px solid #bcddff; border-radius: 6px; margin: 5px; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Datos de Temperatura</h1>
        <div class="temp-value" id="tempActual">-- ¬∞C</div>
        
        <div class="filtros">
            <select id="selectRango" onchange="cargarDatosGrafica()">
                <option value="1">√öltimas 24h</option>
                <option value="3">√öltimos 3 d√≠as</option>
                <option value="7">√öltima semana</option>
                <option value="30">√öltimo mes</option>
            </select>
        </div>

        <div class="chart-container">
            <h3>üìä Gr√°fica de Temperatura</h3>
            <div class="loading" id="loadingChart">Cargando gr√°fica...</div>
            <div class="chart-wrapper">
                <canvas id="tempChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>üìà Histograma de Temperaturas</h3>
            <div class="chart-wrapper">
                <canvas id="histogramChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>üìã Tabla Hist√≥rica</h3>
            <div class="filtros">
                <input type="date" id="filtroFecha" onchange="filtrarTablaPorFecha()">
                <button onclick="mostrarTodasLasFechas()">üìÖ Todas las Fechas</button>
            </div>
            <div class="tabla-container">
                <table class="tabla-historico">
                    <thead>
                        <tr><th>Fecha</th><th>Hora</th><th>Temp</th><th>Estado</th></tr>
                    </thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
        
        <a href="https://flashtemp.netlify.app">‚Üê Inicio</a>
        <a href="humedad.html">Humedad ‚Üí</a>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBm2mXJJpJZulKtTfLhoPX2-f2KhzdnSQw",
            authDomain: "flashtemp-87a59.firebaseapp.com",
            databaseURL: "https://flashtemp-87a59-default-rtdb.firebaseio.com",
            projectId: "flashtemp-87a59",
            storageBucket: "flashtemp-87a59.firebasestorage.app",
            messagingSenderId: "383528508510",
            appId: "1:383528508510:web:76a8cc4a8cb55c9c9928cf"
        };

        firebase.initializeApp(firebaseConfig);
        
        let tempChart, histogramChart;
        let todosLosDatos = [];

        async function cargarTodosLosDatos() {
            console.log("üì• Cargando datos desde Firebase...");
            try {
                const snapshot = await firebase.database().ref('historico').once('value');
                const historico = snapshot.val();
                
                todosLosDatos = [];
                if (historico) {
                    Object.keys(historico).forEach(fecha => {
                        Object.keys(historico[fecha]).forEach(hora => {
                            const dato = historico[fecha][hora];
                            todosLosDatos.push({
                                fecha: fecha,
                                hora: hora,
                                temperatura: dato.temperatura,
                                timestamp: new Date(fecha + 'T' + hora + ':00')
                            });
                        });
                    });
                    
                    todosLosDatos.sort((a, b) => b.timestamp - a.timestamp);
                    console.log(`‚úÖ ${todosLosDatos.length} datos cargados`);
                   
                    cargarDatosGrafica();
                    actualizarTabla();
                } else {
                    console.log("‚ÑπNo hay datos hist√≥ricos a√∫n");
                    document.getElementById('loadingChart').textContent = 'No hay datos hist√≥ricos. El ESP32 guarda datos cada hora.';
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                document.getElementById('loadingChart').textContent = 'Error cargando datos';
            }
        }
        function cargarDatosGrafica() {
            const dias = parseInt(document.getElementById('selectRango').value);
            const fechaLimite = new Date();
            fechaLimite.setDate(fechaLimite.getDate() - dias);
            
            const datosFiltrados = todosLosDatos.filter(d => new Date(d.fecha) >= fechaLimite);
            
            if (datosFiltrados.length === 0) {
                document.getElementById('loadingChart').textContent = 'No hay datos para el per√≠odo seleccionado';
                return;
            }

            document.getElementById('loadingChart').style.display = 'none';

            // Calcular promedios
            let labels = [];
            let promedios = [];

            if (dias === 1) {
                const datosPorHora = {};
                datosFiltrados.forEach(dato => {
                    const clave = dato.hora;
                    if (!datosPorHora[clave]) datosPorHora[clave] = [];
                    datosPorHora[clave].push(dato.temperatura);
                });

                labels = Object.keys(datosPorHora).sort();
                promedios = labels.map(hora => {
                    const temps = datosPorHora[hora];
                    return temps.reduce((a, b) => a + b, 0) / temps.length;
                });

            } else {
                const datosPorDia = {};
                datosFiltrados.forEach(dato => {
                    if (!datosPorDia[dato.fecha]) datosPorDia[dato.fecha] = [];
                    datosPorDia[dato.fecha].push(dato.temperatura);
                });

                labels = Object.keys(datosPorDia).sort();
                promedios = labels.map(fecha => {
                    const temps = datosPorDia[fecha];
                    return temps.reduce((a, b) => a + b, 0) / temps.length;
                });

                // Formatear labels para d√≠as
                labels = labels.map(fecha => {
                    const [a√±o, mes, dia] = fecha.split('-');
                    return `${dia}/${mes}`;
                });
            }

            crearGraficaPrincipal(labels, promedios);
            crearHistograma(datosFiltrados.map(d => d.temperatura));
        }

        function crearGraficaPrincipal(labels, datos) {
            const ctx = document.getElementById('tempChart').getContext('2d');
            
            if (tempChart) tempChart.destroy();
            
            tempChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temperatura Promedio (¬∞C)',
                        data: datos,
                        borderColor: '#ffeb3b',
                        backgroundColor: 'rgba(255, 235, 59, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } },
                        tooltip: { backgroundColor: 'rgba(0,0,0,0.8)' }
                    },
                    scales: {
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { 
                            ticks: { color: 'white' }, 
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            min: 15,
                            max: 40
                        }
                    }
                }
            });
        }

        // Histograma de frecuencias
        function crearHistograma(temperaturas) {
            const ctx = document.getElementById('histogramChart').getContext('2d');
            
            if (histogramChart) histogramChart.destroy();

            //rangos de temperatura 
            const bins = [];
            const binSize = 2; 
            for (let i = 15; i <= 40; i += binSize) {
                const count = temperaturas.filter(temp => temp >= i && temp < i + binSize).length;
                bins.push({ range: `${i}-${i+binSize}¬∞C`, count: count });
            }

            histogramChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.map(b => b.range),
                    datasets: [{
                        label: 'Frecuencia',
                        data: bins.map(b => b.count),
                        backgroundColor: 'rgba(255, 235, 59, 0.6)',
                        borderColor: '#ffeb3b',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: 'white' } }
                    },
                    scales: {
                        x: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        // Tabla (optimizada)
        function actualizarTabla() {
            const cuerpoTabla = document.getElementById('cuerpoTabla');
            const datosMostrar = todosLosDatos.slice(0, 20); 
            
            cuerpoTabla.innerHTML = datosMostrar.map(dato => {
                const estado = dato.temperatura >= 28 ? 'Caluroso' : dato.temperatura <= 20 ? 'Fr√≠o' : 'Normal';
                const claseEstado = dato.temperatura >= 28 ? 'estado-calido' : dato.temperatura <= 20 ? 'estado-frio' : 'estado-normal';
                return `<tr>
                    <td>${dato.fecha}</td>
                    <td>${dato.hora}</td>
                    <td>${dato.temperatura.toFixed(1)}¬∞C</td>
                    <td class="${claseEstado}">${estado}</td>
                </tr>`;
            }).join('');
        }

        function filtrarTablaPorFecha() {
            const fecha = document.getElementById('filtroFecha').value;
            if (!fecha) actualizarTabla();
        }

        function mostrarTodasLasFechas() {
            document.getElementById('filtroFecha').value = '';
            actualizarTabla();
        }

        // Temperatura actual
        firebase.database().ref('temperatura').on('value', (snapshot) => {
            const temp = snapshot.val();
            if (temp !== null) {
                document.getElementById('tempActual').innerText = temp.toFixed(1) + " ¬∞C";
            }
        });

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            cargarTodosLosDatos();
        });
    </script>
</body>
</html>


