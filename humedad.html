<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Humedad - FlashTemp</title>
    <link rel="icon" type="image/x-icon" href="https://i.ibb.co/Z1wrYWB0/logo-flashtemp-modified.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #104554;
            color: white;
            text-align: center;
            padding: 15px;
            background-image: url(https://cdn.pixabay.com/photo/2022/06/18/21/47/tree-7270738_1280.jpg);
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            max-width: 1000px;
            margin: 0 auto 15px;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .hum-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4fc3f7;
            margin: 15px 0;
        }
        .chart-container {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .chart-wrapper {
            height: 300px;
            position: relative;
        }
        .chart-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
        }
        .pie-charts-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .pie-chart-wrapper {
            flex: 1;
            min-width: 300px;
            height: 300px;
            position: relative;
        }
        .filtros {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        select, button, input[type="date"] {
            padding: 10px 15px;
            border-radius: 6px;
            border: 2px solid #bcddff;
            background: rgba(188, 221, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .tabla-container {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        .tabla-historico {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
        }
        .tabla-historico th {
            background: rgba(188, 221, 255, 0.2);
            padding: 12px;
            text-align: left;
            font-weight: bold;
            color: #4fc3f7;
            position: sticky;
            top: 0;
        }
        .tabla-historico td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .estado-humedo { color: #4fc3f7; font-weight: bold; }
        .estado-normal { color: #81c784; }
        .estado-seco { color: #ffb74d; font-weight: bold; }
        .loading { color: #bcddff; margin: 10px 0; }
        a { color: #bcddff; text-decoration: none; padding: 8px 16px; border: 2px solid #bcddff; border-radius: 6px; margin: 5px; display: inline-block; }
        .chart-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #4fc3f7;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Datos de Humedad</h1>
        <div class="hum-value" id="humActual">-- %</div>
        
        <div class="filtros">
            <select id="selectRango" onchange="cargarDatosGrafica()">
                <option value="1">√öltimas 24h</option>
                <option value="3">√öltimos 3 d√≠as</option>
                <option value="7">√öltima semana</option>
                <option value="30">√öltimo mes</option>
            </select>
        </div>

        <div class="chart-container">
            <h3>Gr√°fica de Humedad</h3>
            <div class="loading" id="loadingChart">Cargando gr√°fica...</div>
            <div class="chart-wrapper">
                <canvas id="humChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>An√°lisis de Humedad</h3>
            <div class="pie-charts-container">
                <div class="pie-chart-wrapper">
                    <div class="chart-title">Distribuci√≥n por Rango</div>
                    <canvas id="pieChartRangos"></canvas>
                </div>
                <div class="pie-chart-wrapper">
                    <div class="chart-title">Distribuci√≥n por Estado</div>
                    <canvas id="pieChartEstados"></canvas>
                </div>
            </div>
        </div>

        <div class="chart-container">
            <h3>Tabla Hist√≥rica</h3>
            <div class="filtros">
                <input type="date" id="filtroFecha" onchange="filtrarTablaPorFecha()">
                <button onclick="mostrarTodasLasFechas()">Todas las Fechas</button>
            </div>
            <div class="tabla-container">
                <table class="tabla-historico">
                    <thead>
                        <tr><th>Fecha</th><th>Hora</th><th>Humedad</th><th>Estado</th></tr>
                    </thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
        
        <a href="hhttps://rafaelee14.github.io/FlashTemp/">‚Üê Inicio</a>
        <a href="temperatura.html">Temperatura ‚Üí</a>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBm2mXJJpJZulKtTfLhoPX2-f2KhzdnSQw",
            authDomain: "flashtemp-87a59.firebaseapp.com",
            databaseURL: "https://flashtemp-87a59-default-rtdb.firebaseio.com",
            projectId: "flashtemp-87a59",
            storageBucket: "flashtemp-87a59.firebasestorage.app",
            messagingSenderId: "383528508510",
            appId: "1:383528508510:web:76a8cc4a8cb55c9c9928cf"
        };

        firebase.initializeApp(firebaseConfig);
        
        let humedadChart, pieChartRangos, pieChartEstados;
        let todosLosDatos = [];

        async function cargarTodosLosDatos() {
            try {
                const snapshot = await firebase.database().ref('historico').once('value');
                const historico = snapshot.val();
                
                console.log("Datos de Firebase:", historico);
                
                todosLosDatos = [];
                if (historico) {
                    Object.keys(historico).forEach(fecha => {
                        Object.keys(historico[fecha]).forEach(hora => {
                            const dato = historico[fecha][hora];
                            // CORRECCI√ìN: Verificar que el dato tenga humedad
                            if (dato && typeof dato.humedad === 'number') {
                                todosLosDatos.push({
                                    fecha: fecha,
                                    hora: hora,
                                    humedad: dato.humedad,
                                    timestamp: new Date(fecha + 'T' + hora + ':00')
                                });
                            }
                        });
                    });
                    
                    todosLosDatos.sort((a, b) => b.timestamp - a.timestamp);
                    console.log("Datos procesados:", todosLosDatos.length);
                    console.log("Ejemplo de datos:", todosLosDatos.slice(0, 3));
                    
                    const loadingElement = document.getElementById('loadingChart');
                    if (loadingElement) loadingElement.style.display = 'none';
                    
                    cargarDatosGrafica();
                    actualizarTabla();
                } else {
                    console.log("No hay datos hist√≥ricos");
                    mostrarDatosDeEjemploTemporal();
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                mostrarDatosDeEjemploTemporal();
            }
        }

        function cargarDatosGrafica() {
            if (todosLosDatos.length === 0) {
                console.log("No hay datos para gr√°ficas");
                mostrarDatosDeEjemploTemporal();
                return;
            }

            const dias = parseInt(document.getElementById('selectRango').value);
            const fechaLimite = new Date();
            fechaLimite.setDate(fechaLimite.getDate() - dias);
            fechaLimite.setHours(0, 0, 0, 0); 
            
            console.log("Fecha l√≠mite para filtrar:", fechaLimite);
            console.log("Total de datos disponibles:", todosLosDatos.length);

            const datosFiltrados = todosLosDatos.filter(d => d.timestamp >= fechaLimite);
            
            console.log("Datos filtrados para gr√°fica:", datosFiltrados.length);

            if (datosFiltrados.length === 0) {
                console.log("No hay datos filtrados - mostrando todos los datos disponibles");
    
                crearGraficasConDatos(todosLosDatos);
                return;
            }

            crearGraficasConDatos(datosFiltrados);
        }

        function crearGraficasConDatos(datos) {
            console.log("Creando gr√°ficas con", datos.length, "datos");
            
            if (datos.length === 0) {
                console.log("No hay datos para crear gr√°ficas");
                mostrarDatosDeEjemploTemporal();
                return;
            }

            const dias = parseInt(document.getElementById('selectRango').value);
            let labels = [];
            let promedios = [];

            if (dias === 1) {
             
                const datosPorHora = {};
                datos.forEach(dato => {
                    const hora = dato.hora.substring(0, 5); 
                    if (!datosPorHora[hora]) datosPorHora[hora] = [];
                    datosPorHora[hora].push(dato.humedad);
                });

                labels = Object.keys(datosPorHora).sort();
                promedios = labels.map(hora => {
                    const humedades = datosPorHora[hora];
                    return humedades.reduce((a, b) => a + b, 0) / humedades.length;
                });

            } else {
               
                const datosPorDia = {};
                datos.forEach(dato => {
                    if (!datosPorDia[dato.fecha]) datosPorDia[dato.fecha] = [];
                    datosPorDia[dato.fecha].push(dato.humedad);
                });

                labels = Object.keys(datosPorDia).sort();
                promedios = labels.map(fecha => {
                    const humedades = datosPorDia[fecha];
                    return humedades.reduce((a, b) => a + b, 0) / humedades.length;
                });

                labels = labels.map(fecha => {
                    const [a√±o, mes, dia] = fecha.split('-');
                    return `${dia}/${mes}`;
                });
            }

            console.log("Labels:", labels);
            console.log("Promedios:", promedios);
            
            crearGraficaPrincipal(labels, promedios);
            crearGraficasPastel(datos);
        }

        function crearGraficaPrincipal(labels, datos) {
            const canvas = document.getElementById('humChart');
            if (!canvas) {
                console.log("Canvas no encontrado");
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            if (humedadChart) {
                humedadChart.destroy();
            }
            
            console.log("üîÑ Creando gr√°fica principal...");
            
            humedadChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Humedad (%)',
                        data: datos,
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.3)',
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#2196f3',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000
                    },
                    plugins: {
                        legend: { 
                            display: true, 
                            labels: { 
                                color: 'white', 
                                font: { size: 14, weight: 'bold' } 
                            } 
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: 'white', font: { size: 12 } },
                            grid: { color: 'rgba(255,255,255,0.2)' }
                        },
                        y: { 
                            ticks: { color: 'white', font: { size: 12 } },
                            grid: { color: 'rgba(255,255,255,0.2)' },
                            min: Math.max(0, Math.min(...datos) - 5),
                            max: Math.min(100, Math.max(...datos) + 5),
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    }
                }
            });
            
            console.log("Gr√°fica principal creada");
        }

        function crearGraficasPastel(datos) {
            console.log("Creando gr√°ficas de pastel para humedad...");
            
            crearPastelRangos(datos.map(d => d.humedad));
            
            crearPastelEstados(datos.map(d => d.humedad));
        }

        function crearPastelRangos(humedades) {
            const canvas = document.getElementById('pieChartRangos');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (pieChartRangos) {
                pieChartRangos.destroy();
            }

            const rangos = [
                { min: 0, max: 20, label: '0-20%', color: '#FF6384' },  
                { min: 20, max: 40, label: '20-40%', color: '#FF9F40' },  
                { min: 40, max: 60, label: '40-60%', color: '#FFCE56' },  
                { min: 60, max: 80, label: '60-80%', color: '#4BC0C0' },  
                { min: 80, max: 100, label: '80-100%', color: '#36A2EB' } 
            ];

            const conteoRangos = rangos.map(rango => {
                const count = humedades.filter(hum => hum >= rango.min && hum < rango.max).length;
                return {
                    label: rango.label,
                    count: count,
                    porcentaje: ((count / humedades.length) * 100).toFixed(1),
                    color: rango.color
                };
            });

            console.log("Distribuci√≥n por rangos de humedad:", conteoRangos);

            pieChartRangos = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: conteoRangos.map(r => `${r.label} (${r.porcentaje}%)`),
                    datasets: [{
                        data: conteoRangos.map(r => r.count),
                        backgroundColor: conteoRangos.map(r => r.color),
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                font: { size: 11 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label.split(' (')[0]}: ${value} mediciones (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }

        function crearPastelEstados(humedades) {
            const canvas = document.getElementById('pieChartEstados');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            if (pieChartEstados) {
                pieChartEstados.destroy();
            }

            const estados = [
               { tipo: 'Seco', max: 30, color: '#FF6384' },    // Rosa rojizo
               { tipo: 'Normal', min: 30, max: 70, color: '#FFCE56' }, // Amarillo
               { tipo: 'H√∫medo', min: 70, color: '#36A2EB' }   // Azul
            ];

            const conteoEstados = estados.map(estado => {
                let count;
                if (estado.tipo === 'Seco') {
                    count = humedades.filter(hum => hum <= estado.max).length;
                } else if (estado.tipo === 'H√∫medo') {
                    count = humedades.filter(hum => hum >= estado.min).length;
                } else {
                    count = humedades.filter(hum => hum > estado.min && hum < estado.max).length;
                }
                
                return {
                    label: estado.tipo,
                    count: count,
                    porcentaje: ((count / humedades.length) * 100).toFixed(1),
                    color: estado.color
                };
            });

            console.log("Distribuci√≥n por estados de humedad:", conteoEstados);

            pieChartEstados = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: conteoEstados.map(e => `${e.label} (${e.porcentaje}%)`),
                    datasets: [{
                        data: conteoEstados.map(e => e.count),
                        backgroundColor: conteoEstados.map(e => e.color),
                        borderColor: 'white',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'white',
                                font: { size: 11 },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `${label.split(' (')[0]}: ${value} mediciones (${percentage}%)`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000
                    }
                }
            });
        }

        function mostrarDatosDeEjemploTemporal() {
            console.log("üîÑ Mostrando datos de ejemplo temporal...");
            const loadingElement = document.getElementById('loadingChart');
            if (loadingElement) loadingElement.style.display = 'none';
            
            const labels = ['14:00', '15:00', '16:00', '17:00', '18:00'];
            const datos = [65, 68, 72, 70, 67];
            
            crearGraficaPrincipal(labels, datos);
            crearGraficasPastel(datos);
        }

        function actualizarTabla() {
            const cuerpoTabla = document.getElementById('cuerpoTabla');
            if (!cuerpoTabla) return;
            
            if (todosLosDatos.length === 0) {
                cuerpoTabla.innerHTML = '<tr><td colspan="4" style="text-align: center;">No hay datos</td></tr>';
                return;
            }
            
            const datosMostrar = todosLosDatos.slice(0, 20);
            
            cuerpoTabla.innerHTML = datosMostrar.map(dato => {
                const estado = dato.humedad >= 70 ? 'H√∫medo' : dato.humedad <= 30 ? 'Seco' : 'Normal';
                const claseEstado = dato.humedad >= 70 ? 'estado-humedo' : dato.humedad <= 30 ? 'estado-seco' : 'estado-normal';
                return `<tr>
                    <td>${dato.fecha}</td>
                    <td>${dato.hora}</td>
                    <td>${dato.humedad.toFixed(1)}%</td>
                    <td class="${claseEstado}">${estado}</td>
                </tr>`;
            }).join('');
        }

        function filtrarTablaPorFecha() {
            const fecha = document.getElementById('filtroFecha').value;
            if (!fecha) {
                actualizarTabla();
                return;
            }
            
            const datosFiltrados = todosLosDatos.filter(d => d.fecha === fecha);
            const cuerpoTabla = document.getElementById('cuerpoTabla');
            
            if (datosFiltrados.length === 0) {
                cuerpoTabla.innerHTML = '<tr><td colspan="4" style="text-align: center;">No hay datos para esta fecha</td></tr>';
                return;
            }
            
            cuerpoTabla.innerHTML = datosFiltrados.map(dato => {
                const estado = dato.humedad >= 70 ? 'H√∫medo' : dato.humedad <= 30 ? 'Seco' : 'Normal';
                const claseEstado = dato.humedad >= 70 ? 'estado-humedo' : dato.humedad <= 30 ? 'estado-seco' : 'estado-normal';
                return `<tr>
                    <td>${dato.fecha}</td>
                    <td>${dato.hora}</td>
                    <td>${dato.humedad.toFixed(1)}%</td>
                    <td class="${claseEstado}">${estado}</td>
                </tr>`;
            }).join('');
        }

        function mostrarTodasLasFechas() {
            document.getElementById('filtroFecha').value = '';
            actualizarTabla();
        }

        firebase.database().ref('humedad').on('value', (snapshot) => {
            const humedad = snapshot.val();
            if (humedad !== null) {
                document.getElementById('humActual').innerText = humedad.toFixed(1) + " %";
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            console.log("Iniciando aplicaci√≥n de humedad...");
            cargarTodosLosDatos();
        });

        setTimeout(function() {
            const loadingElement = document.getElementById('loadingChart');
            if (loadingElement && loadingElement.style.display !== 'none') {
                console.log("Forzando visualizaci√≥n...");
                mostrarDatosDeEjemploTemporal();
            }
        }, 5000);
    </script>
</body>
</html>
