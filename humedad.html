<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Humedad - FlashTemp</title>
    <link rel="icon" type="image/x-icon" href="https://i.ibb.co/Z1wrYWB0/logo-flashtemp-modified.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #104554;
            color: white;
            text-align: center;
            padding: 15px;
            background-image: url(https://cdn.pixabay.com/photo/2022/06/18/21/47/tree-7270738_1280.jpg);
            background-size: cover;
            background-position: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            max-width: 1000px;
            margin: 0 auto 15px;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .hum-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #4fc3f7;
            margin: 15px 0;
        }
        .chart-container {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .chart-wrapper {
            height: 300px;
            position: relative;
        }
        .chart-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
        }
        .filtros {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        select, button, input[type="date"] {
            padding: 10px 15px;
            border-radius: 6px;
            border: 2px solid #bcddff;
            background: rgba(188, 221, 255, 0.1);
            color: white;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .tabla-container {
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
        }
        .tabla-historico {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.05);
        }
        .tabla-historico th {
            background: rgba(188, 221, 255, 0.2);
            padding: 12px;
            text-align: left;
            font-weight: bold;
            color: #4fc3f7;
            position: sticky;
            top: 0;
        }
        .tabla-historico td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .estado-humedo { color: #4fc3f7; font-weight: bold; }
        .estado-normal { color: #81c784; }
        .estado-seco { color: #ffb74d; font-weight: bold; }
        .loading { color: #bcddff; margin: 10px 0; }
        a { color: #bcddff; text-decoration: none; padding: 8px 16px; border: 2px solid #bcddff; border-radius: 6px; margin: 5px; display: inline-block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Datos de Humedad</h1>
        <div class="hum-value" id="humActual">-- %</div>
        
        <div class="filtros">
            <select id="selectRango" onchange="cargarDatosGrafica()">
                <option value="1">√öltimas 24h</option>
                <option value="3">√öltimos 3 d√≠as</option>
                <option value="7">√öltima semana</option>
                <option value="30">√öltimo mes</option>
            </select>
        </div>

        <div class="chart-container">
            <h3>Gr√°fica de Humedad</h3>
            <div class="loading" id="loadingChart">Cargando gr√°fica...</div>
            <div class="chart-wrapper">
                <canvas id="humChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>Distribuci√≥n de Humedades</h3>
            <div class="chart-wrapper">
                <canvas id="distribucionChart"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3>Tabla Hist√≥rica</h3>
            <div class="filtros">
                <input type="date" id="filtroFecha" onchange="filtrarTablaPorFecha()">
                <button onclick="mostrarTodasLasFechas()">Todas las Fechas</button>
            </div>
            <div class="tabla-container">
                <table class="tabla-historico">
                    <thead>
                        <tr><th>Fecha</th><th>Hora</th><th>Humedad</th><th>Estado</th></tr>
                    </thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
        
        <a href="https://flashtemp.netlify.app">‚Üê Inicio</a>
        <a href="temperatura.html">Temperatura ‚Üí</a>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBm2mXJJpJZulKtTfLhoPX2-f2KhzdnSQw",
            authDomain: "flashtemp-87a59.firebaseapp.com",
            databaseURL: "https://flashtemp-87a59-default-rtdb.firebaseio.com",
            projectId: "flashtemp-87a59",
            storageBucket: "flashtemp-87a59.firebasestorage.app",
            messagingSenderId: "383528508510",
            appId: "1:383528508510:web:76a8cc4a8cb55c9c9928cf"
        };

        firebase.initializeApp(firebaseConfig);
        
        let humedadChart, histogramChart;
        let todosLosDatos = [];

        async function cargarTodosLosDatos() {
            try {
                const snapshot = await firebase.database().ref('historico').once('value');
                const historico = snapshot.val();
                
                console.log("Datos de Firebase:", historico);
                
                todosLosDatos = [];
                if (historico) {
                    Object.keys(historico).forEach(fecha => {
                        Object.keys(historico[fecha]).forEach(hora => {
                            const dato = historico[fecha][hora];
                            todosLosDatos.push({
                                fecha: fecha,
                                hora: hora,
                                humedad: dato.humedad,
                                timestamp: new Date(fecha + 'T' + hora + ':00')
                            });
                        });
                    });
                    
                    todosLosDatos.sort((a, b) => b.timestamp - a.timestamp);
                    console.log("‚úÖ Datos procesados:", todosLosDatos.length);
                    
                    // OCULTAR MENSAJE DE CARGA INMEDIATAMENTE
                    const loadingElement = document.getElementById('loadingChart');
                    if (loadingElement) loadingElement.style.display = 'none';
                    
                    cargarDatosGrafica();
                    actualizarTabla();
                } else {
                    console.log("‚ùå No hay datos hist√≥ricos");
                    mostrarDatosDeEjemploTemporal();
                }
            } catch (error) {
                console.error('Error cargando datos:', error);
                mostrarDatosDeEjemploTemporal();
            }
        }

        function cargarDatosGrafica() {
            if (todosLosDatos.length === 0) {
                console.log("‚ùå No hay datos para gr√°ficas");
                return;
            }

            const dias = parseInt(document.getElementById('selectRango').value);
            const fechaLimite = new Date();
            fechaLimite.setDate(fechaLimite.getDate() - dias);
            
            const datosFiltrados = todosLosDatos.filter(d => new Date(d.fecha) >= fechaLimite);
            
            console.log("üìà Datos filtrados para gr√°fica:", datosFiltrados.length);

            if (datosFiltrados.length === 0) {
                console.log("No hay datos filtrados");
                return;
            }

            let labels = [];
            let promedios = [];

            if (dias === 1) {
                const datosPorHora = {};
                datosFiltrados.forEach(dato => {
                    const clave = dato.hora;
                    if (!datosPorHora[clave]) datosPorHora[clave] = [];
                    datosPorHora[clave].push(dato.humedad);
                });

                labels = Object.keys(datosPorHora).sort();
                promedios = labels.map(hora => {
                    const humedades = datosPorHora[hora];
                    return humedades.reduce((a, b) => a + b, 0) / humedades.length;
                });

            } else {
                const datosPorDia = {};
                datosFiltrados.forEach(dato => {
                    if (!datosPorDia[dato.fecha]) datosPorDia[dato.fecha] = [];
                    datosPorDia[dato.fecha].push(dato.humedad);
                });

                labels = Object.keys(datosPorDia).sort();
                promedios = labels.map(fecha => {
                    const humedades = datosPorDia[fecha];
                    return humedades.reduce((a, b) => a + b, 0) / humedades.length;
                });

                labels = labels.map(fecha => {
                    const [a√±o, mes, dia] = fecha.split('-');
                    return `${dia}/${mes}`;
                });
            }

            console.log("Creando gr√°ficas con:", labels, promedios);
            crearGraficaPrincipal(labels, promedios);
            crearHistograma(datosFiltrados.map(d => d.humedad));
        }

        function crearGraficaPrincipal(labels, datos) {
            const canvas = document.getElementById('humedadChart');
            if (!canvas) {
                console.log("Canvas no encontrado");
                return;
            }
          
            canvas.style.width = "100%";
            canvas.style.height = "300px";
            
            const ctx = canvas.getContext('2d');
       
            if (humedadChart) {
                humedadChart.destroy();
            }
            
            console.log("üîÑ Creando gr√°fica principal...");
            
            humedadChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Humedad (%)',
                        data: datos,
                        borderColor: '#2196f3',
                        backgroundColor: 'rgba(33, 150, 243, 0.3)',
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#2196f3',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000
                    },
                    plugins: {
                        legend: { 
                            display: true, 
                            labels: { 
                                color: 'white', 
                                font: { size: 14, weight: 'bold' } 
                            } 
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: 'white', font: { size: 12 } },
                            grid: { color: 'rgba(255,255,255,0.2)' }
                        },
                        y: { 
                            ticks: { color: 'white', font: { size: 12 } },
                            grid: { color: 'rgba(255,255,255,0.2)' },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
            
            console.log("Gr√°fica principal creada");
        }

        function crearHistograma(humedades) {
            const canvas = document.getElementById('histogramChart');
            if (!canvas) return;
            
            canvas.style.width = "100%";
            canvas.style.height = "300px";
            
            const ctx = canvas.getContext('2d');
            
            if (histogramChart) histogramChart.destroy();

            const bins = [];
            const binSize = 10;
            for (let i = 0; i <= 100; i += binSize) {
                const count = humedades.filter(hum => hum >= i && hum < i + binSize).length;
                bins.push({ range: `${i}-${i+binSize}%`, count: count });
            }

            histogramChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: bins.map(b => b.range),
                    datasets: [{
                        label: 'Frecuencia',
                        data: bins.map(b => b.count),
                        backgroundColor: 'rgba(33, 150, 243, 0.8)',
                        borderColor: '#2196f3',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000
                    },
                    plugins: {
                        legend: { 
                            display: true, 
                            labels: { color: 'white', font: { size: 14 } } 
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: 'white', font: { size: 11 } },
                            grid: { color: 'rgba(255,255,255,0.2)' }
                        },
                        y: { 
                            ticks: { color: 'white', font: { size: 12 } },
                            grid: { color: 'rgba(255,255,255,0.2)' }
                        }
                    }
                }
            });
            
            console.log("‚úÖ Histograma creado");
        }

        function mostrarDatosDeEjemploTemporal() {
            console.log("üîÑ Mostrando datos de ejemplo temporal...");
            const loadingElement = document.getElementById('loadingChart');
            if (loadingElement) loadingElement.style.display = 'none';
            
            const labels = ['14:00', '15:00', '16:00', '17:00', '18:00'];
            const datos = [65, 68, 72, 70, 67];
            
            crearGraficaPrincipal(labels, datos);
            crearHistograma(datos);
        }

        function actualizarTabla() {
            const cuerpoTabla = document.getElementById('cuerpoTabla');
            if (!cuerpoTabla) return;
            
            if (todosLosDatos.length === 0) {
                cuerpoTabla.innerHTML = '<tr><td colspan="4" style="text-align: center;">No hay datos</td></tr>';
                return;
            }
            
            const datosMostrar = todosLosDatos.slice(0, 20);
            
            cuerpoTabla.innerHTML = datosMostrar.map(dato => {
                const estado = dato.humedad >= 70 ? 'H√∫medo' : dato.humedad <= 30 ? 'Seco' : 'Normal';
                const claseEstado = dato.humedad >= 70 ? 'estado-humedo' : dato.humedad <= 30 ? 'estado-seco' : 'estado-normal';
                return `<tr>
                    <td>${dato.fecha}</td>
                    <td>${dato.hora}</td>
                    <td>${dato.humedad.toFixed(1)}%</td>
                    <td class="${claseEstado}">${estado}</td>
                </tr>`;
            }).join('');
        }

        function filtrarTablaPorFecha() {
            const fecha = document.getElementById('filtroFecha').value;
            if (!fecha) actualizarTabla();
        }

        function mostrarTodasLasFechas() {
            document.getElementById('filtroFecha').value = '';
            actualizarTabla();
        }

        firebase.database().ref('humedad').on('value', (snapshot) => {
            const humedad = snapshot.val();
            if (humedad !== null) {
                document.getElementById('humedadActual').innerText = humedad.toFixed(1) + " %";
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            console.log("Iniciando aplicaci√≥n de humedad...");
            cargarTodosLosDatos();
        });

        setTimeout(function() {
            const loadingElement = document.getElementById('loadingChart');
            if (loadingElement && loadingElement.style.display !== 'none') {
                console.log("Forzando visualizaci√≥n...");
                mostrarDatosDeEjemploTemporal();
            }
        }, 5000);
    </script>
</body>
</html>
